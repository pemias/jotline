<script lang="ts">
  import { t } from "@/i18n";
  import { toast } from "svelte-sonner";
  import type { ModelInfo } from "@/bindings";
  import type { ModelCardStatus } from "./ModelCard.svelte";
  import ModelCard from "./ModelCard.svelte";
  import HandyTextLogo from "../icons/HandyTextLogo.svelte";
  import {
    models,
    downloadModel,
    selectModel,
    downloadingModels,
    extractingModels,
    downloadProgress,
    downloadStats,
  } from "../../stores/modelStore";

  let {
    onModelSelected,
  }: {
    onModelSelected: () => void;
  } = $props();

  let selectedModelId = $state<string | null>(null);

  let isDownloading = $derived(selectedModelId !== null);

  // Watch for the selected model to finish downloading + extracting
  $effect(() => {
    if (!selectedModelId) return;

    const model = $models.find((m) => m.id === selectedModelId);
    const stillDownloading = selectedModelId in $downloadingModels;
    const stillExtracting = selectedModelId in $extractingModels;

    if (model?.is_downloaded && !stillDownloading && !stillExtracting) {
      selectModel(selectedModelId).then((success) => {
        if (success) {
          onModelSelected();
        } else {
          toast.error($t("onboarding.errors.selectModel"));
          selectedModelId = null;
        }
      });
    }
  });

  const handleDownloadModel = async (modelId: string) => {
    selectedModelId = modelId;

    const success = await downloadModel(modelId);
    if (!success) {
      toast.error($t("onboarding.downloadFailed"));
      selectedModelId = null;
    }
  };

  const getModelStatus = (modelId: string): ModelCardStatus => {
    if (modelId in $extractingModels) return "extracting";
    if (modelId in $downloadingModels) return "downloading";
    return "downloadable";
  };

  const getModelDownloadProgress = (modelId: string): number | undefined => {
    return $downloadProgress[modelId]?.percentage;
  };

  const getModelDownloadSpeed = (modelId: string): number | undefined => {
    return $downloadStats[modelId]?.speed;
  };

  let recommendedModels = $derived(
    $models
      .filter((m: ModelInfo) => !m.is_downloaded)
      .filter((model: ModelInfo) => model.is_recommended)
  );

  let otherModels = $derived(
    $models
      .filter((m: ModelInfo) => !m.is_downloaded)
      .filter((model: ModelInfo) => !model.is_recommended)
      .sort((a: ModelInfo, b: ModelInfo) => Number(a.size_mb) - Number(b.size_mb))
  );
</script>

<div class="h-screen w-screen flex flex-col p-6 gap-4 inset-0">
  <div class="flex flex-col items-center gap-2 shrink-0">
    <HandyTextLogo width={200} />
    <p class="text-text/70 max-w-md font-medium mx-auto">
      {$t("onboarding.subtitle")}
    </p>
  </div>

  <div class="max-w-[600px] w-full mx-auto text-center flex-1 flex flex-col min-h-0">
    <div class="flex flex-col gap-4 pb-6">
      {#each recommendedModels as model (model.id)}
        <ModelCard
          {model}
          variant="featured"
          status={getModelStatus(model.id)}
          disabled={isDownloading}
          onSelect={handleDownloadModel}
          onDownload={handleDownloadModel}
          downloadProgress={getModelDownloadProgress(model.id)}
          downloadSpeed={getModelDownloadSpeed(model.id)}
        />
      {/each}

      {#each otherModels as model (model.id)}
        <ModelCard
          {model}
          status={getModelStatus(model.id)}
          disabled={isDownloading}
          onSelect={handleDownloadModel}
          onDownload={handleDownloadModel}
          downloadProgress={getModelDownloadProgress(model.id)}
          downloadSpeed={getModelDownloadSpeed(model.id)}
        />
      {/each}
    </div>
  </div>
</div>
